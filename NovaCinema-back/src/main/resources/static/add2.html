<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>CinemaTest</title>
</head>
<body>
<h1>ğŸ¬ CinemaTest</h1>

<!-- ìŠ¤ì¼€ì¤„ ì„ íƒ -->
<h3>ìƒì˜ ì¼ì • ì„ íƒ</h3>
<select id="scheduleSelect">
    <option value="">-- ìŠ¤ì¼€ì¤„ ì„ íƒ --</option>
    <option value="5001">5001</option>
    <option value="5002">5002</option>
    <option value="5003">5003</option>
    <option value="5004">5004</option>
    <option value="5005">5005</option>
</select>
<button onclick="loadAvailableSeats()">ì¢Œì„ ì¡°íšŒ</button>

<!-- ì¢Œì„ ëª©ë¡ -->
<h3>ì¢Œì„ ì„ íƒ</h3>
<ul id="seatList"></ul>

<!-- ì‚¬ìš©ì ì…ë ¥ í¼ -->
<h3>ì˜ˆë§¤ ì •ë³´ ì…ë ¥</h3>
<label>íšŒì› ì½”ë“œ: <input type="number" id="memberCode" /></label><br>
<label>ê²°ì œ ì‹œê°„: <input type="datetime-local" id="paymentTime" /></label><br><br>

<!-- ì˜ˆë§¤ ë²„íŠ¼ -->
<button onclick="submitReservation()">ì˜ˆë§¤í•˜ê¸°</button>

<script>
    let selectedSeat = null;

    function loadAvailableSeats() {
        const scheduleNum = document.getElementById('scheduleSelect').value;
        if (!scheduleNum) {
            alert('ìƒì˜ ì¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        fetch(`http://localhost:8082/seatReservation/available?scheduleNum=${scheduleNum}`)
            .then(response => response.json())
            .then(data => {
                const seatList = document.getElementById('seatList');
                seatList.innerHTML = '';
                data.forEach(seat => {
                    const seatLabel = seat.seatRealNum ?? `${seat.rowLabel}${seat.colNum}`;
                    const price = seat.sale ?? seat.price;
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <label>
                            <input type="radio" name="seatSelect" value="${seat.seatCode}" />
                            ${seatLabel} (${seat.seatType}, ${price}ì›)
                        </label>
                    `;
                    seatList.appendChild(li);
                });

                document.querySelectorAll('input[name="seatSelect"]').forEach(input => {
                    input.addEventListener('change', () => {
                        selectedSeat = input.value;
                    });
                });
            })
            .catch(error => {
                console.error('ì¢Œì„ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert('ì¢Œì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    function submitReservation() {
        const scheduleNum = document.getElementById('scheduleSelect').value;
        const memberCode = document.getElementById('memberCode').value;
        const paymentTime = document.getElementById('paymentTime').value;

        if (!selectedSeat || !memberCode || !paymentTime || !scheduleNum) {
            alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì¢Œì„ê³¼ ìŠ¤ì¼€ì¤„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const payload = {
            reservationDTO: {
                seatNumber: parseInt(selectedSeat),
                paymentTime: paymentTime,
                state: "ì˜ˆì•½ì™„ë£Œ",
                memberCode: parseInt(memberCode),
                scheduleNum: parseInt(scheduleNum)
            },
            seatReservationDTO: {
                scheduleNum: parseInt(scheduleNum),
                seatCode: parseInt(selectedSeat),
                reserved: true,
                reservedAt: paymentTime
            }
        };

        fetch('http://localhost:8082/api/reservations/insert2', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
            .then(response => response.text().then(msg => {
                if (response.ok) {
                    alert(msg); // ì„±ê³µ ë©”ì‹œì§€
                    loadAvailableSeats();
                } else {
                    alert('ì˜ˆë§¤ ì‹¤íŒ¨: ' + msg); // ì‹¤íŒ¨ ë©”ì‹œì§€
                }
            }))
            .catch(error => {
                console.error('ì˜ˆë§¤ ìš”ì²­ ì‹¤íŒ¨:', error);
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }
</script>
</body>
</html>
