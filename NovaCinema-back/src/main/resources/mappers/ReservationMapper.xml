<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.novacinema.reservation.model.dao.ReservationMapper">

    <!-- ðŸŽ¬ ì˜í™”ê´€ ì§€ì  -->
    <resultMap id="cinemaFranchiseResultMap" type="com.novacinema.cinemaFranchise.model.dto.CinemaFranchiseDTO">
        <id property="branchNum" column="branch_num"/>
        <result property="branchName" column="branch_name"/>
        <result property="address" column="address"/>
    </resultMap>

    <!-- ðŸŽ¥ ìƒì˜ê´€ -->
    <resultMap id="theaterResultMap" type="com.novacinema.theater.model.dto.TheaterDTO">
        <id property="screeningNum" column="th_screening_num"/>
        <result property="screeningNumber" column="screening_number"/>
        <result property="branchNum" column="branch_num"/>
        <association property="cinemaFranchisedto" resultMap="cinemaFranchiseResultMap"/>
    </resultMap>

    <!-- ðŸŽžï¸ ì˜í™” ì •ë³´ -->
    <resultMap id="infoResultMap" type="com.novacinema.info.model.dto.InfoDTO">
        <id property="movieNum" column="movie_num"/>
        <result property="movieTitle" column="movie_title"/>
        <result property="runningTime" column="running_time"/>
        <result property="audienceRating" column="audience_rating"/>
    </resultMap>

    <!-- ðŸ“… ìƒì˜ ì¼ì • ì •ë³´ -->
    <resultMap id="scheduleResultMap" type="com.novacinema.schedule.model.dto.ScheduleDTO">
        <id property="scheduleNum" column="schedule_num"/>
        <result property="screeningDate" column="screening_date"/>
        <result property="screeningNum" column="screening_num"/>
        <result property="movieNum" column="movie_num"/>
        <association property="movieInfo" resultMap="infoResultMap"/>
        <association property="theaterInfo" resultMap="theaterResultMap"/>
    </resultMap>

    <!-- ðŸŽ« ì¢Œì„ ì •ë³´ -->
    <resultMap id="seatResultMap" type="com.novacinema.seat.model.dto.SeatDTO">
        <id property="seatCode" column="seat_code"/>
        <result property="seatType" column="seat_type"/>
        <result property="screeningNum" column="screening_num"/>
        <result property="price" column="price"/>
        <result property="isAisle" column="is_aisle"/>
        <result property="rowLabel" column="row_label"/>
        <result property="colNum" column="col_num"/>
        <result property="seatRealNum" column="seat_real_num"/>
    </resultMap>


    <!-- ðŸ™‹ íšŒì› ì •ë³´ -->
    <resultMap id="userResultMap" type="com.novacinema.user.model.dto.UserDTO">
        <id property="memberCode" column="member_code"/>
        <result property="memberName" column="member_name"/>
        <result property="id" column="id"/>
        <result property="password" column="password"/>
        <result property="phoneNumber" column="phone_number"/>
    </resultMap>

    <!-- ðŸ“¦ ì˜ˆì•½ ì •ë³´ -->
    <resultMap id="reservationInfoDetailResultMap" type="com.novacinema.reservation.model.dto.ReservationDTO">
        <id property="reservationNum" column="reservation_num"/>
        <result property="seatNumber" column="seat_number"/>
        <result property="paymentTime" column="payment_time"/>
        <result property="state" column="state"/>
        <result property="phoneNumber" column="phone_number"/>
        <result property="scheduleNum" column="schedule_num"/>
        <result property="bookingGroupId" column="booking_group_id"/>
        <result property="transactionNum" column="transaction_num"/> <!-- âœ… ì¶”ê°€ -->
        <association property="seatDTO" resultMap="seatResultMap"/>
        <association property="userDTO" resultMap="userResultMap"/>
        <association property="scheduleDTO" resultMap="scheduleResultMap"/>
    </resultMap>

    <!-- ðŸ” ì˜ˆì•½ ì „ì²´ ì¡°íšŒ -->
    <select id="selectAllReservations" resultMap="reservationInfoDetailResultMap">
        SELECT
        r.reservation_num,
        r.seat_number,
        r.payment_time,
        r.state,
        r.phone_number,
        r.schedule_num,
        r.booking_group_id,
        r.transaction_num,

        s.seat_code,
        s.seat_type,
        s.price,
        s.screening_num,
        s.is_aisle,
        s.row_label,
        s.col_num,

        m.member_code,
        m.member_name,
        m.id,
        m.password,
        m.phone_number,

        sc.schedule_num,
        sc.screening_date,
        sc.screening_num,
        sc.movie_num,

        i.movie_num,
        i.movie_title,
        i.running_time,
        i.audience_rating,

        th.screening_num AS th_screening_num,
        th.screening_number,
        th.branch_num,

        cf.branch_name,
        cf.address

        FROM T_ReservationInfo r
        JOIN T_Seat s ON r.seat_number = s.seat_code
        JOIN T_MemberInfo m ON r.phone_number = m.phone_number
        JOIN T_Schedule sc ON r.schedule_num = sc.schedule_num
        JOIN T_Info i ON sc.movie_num = i.movie_num
        JOIN T_Theater th ON sc.screening_num = th.screening_num
        JOIN T_CinemaFranchise cf ON th.branch_num = cf.branch_num


    </select>

    <!-- ðŸ” íŠ¹ì • íšŒì›ì˜ ì˜ˆì•½ ì¡°íšŒ -->
    <select id="selectReservationsByPhoneNumber" parameterType="string" resultMap="reservationInfoDetailResultMap">
        SELECT
        r.reservation_num,
        r.seat_number,
        r.payment_time,
        r.state,
        r.phone_number,
        r.schedule_num,
        r.booking_group_id,
        r.transaction_num,

        s.seat_code,
        s.seat_type,
        s.price,
        s.screening_num,
        s.is_aisle,
        s.row_label,
        s.col_num,

        m.member_code,
        m.member_name,
        m.id,
        m.password,
        m.phone_number,

        sc.schedule_num,
        sc.screening_date,
        sc.screening_num,
        sc.movie_num,

        i.movie_num,
        i.movie_title,
        i.running_time,
        i.audience_rating,

        th.screening_num AS th_screening_num,
        th.screening_number,
        th.branch_num,

        cf.branch_name,
        cf.address

        FROM T_ReservationInfo r
        JOIN T_Seat s ON r.seat_number = s.seat_code
        JOIN T_MemberInfo m ON r.phone_number = m.phone_number
        JOIN T_Schedule sc ON r.schedule_num = sc.schedule_num
        JOIN T_Info i ON sc.movie_num = i.movie_num
        JOIN T_Theater th ON sc.screening_num = th.screening_num
        JOIN T_CinemaFranchise cf ON th.branch_num = cf.branch_num
        WHERE r.phone_number = #{phoneNumber}

    </select>

    <!-- ðŸ“ ì˜ˆì•½ ë“±ë¡ -->
    <insert id="insertReservation" parameterType="com.novacinema.reservation.model.dto.ReservationDTO">
        INSERT INTO T_ReservationInfo (
        reservation_num,
        seat_number,
        payment_time,
        state,
        phone_number,
        schedule_num,
        booking_group_id,
        transaction_num
        ) VALUES (
        #{reservationNum},
        #{seatNumber},
        #{paymentTime},
        #{state},
        #{phoneNumber},
        #{scheduleNum},
        #{bookingGroupId},
        #{transactionNum}
        )
    </insert>

    <select id="findMaxReservationIdForToday" resultType="String">
        SELECT MAX(reservation_num)
        FROM T_ReservationInfo
        WHERE reservation_num LIKE #{prefix}
    </select>

    <update id="updateReservationState" parameterType="map">
        UPDATE T_ReservationInfo
        SET state = #{state}
        WHERE reservation_num = #{reservationNum}
    </update>
    <select id="selectReservationByNum"
            parameterType="string"
            resultMap="reservationInfoDetailResultMap">
        SELECT
        r.reservation_num,
        r.seat_number,
        r.payment_time,
        r.state,
        r.phone_number,
        r.schedule_num,
        r.transaction_num,

        s.seat_code,
        s.seat_type,
        s.price,
        s.screening_num,
        s.is_aisle,
        s.row_label,
        s.col_num,

        m.member_code,
        m.member_name,
        m.id,
        m.password,
        m.phone_number,

        sc.schedule_num,
        sc.screening_date,
        sc.screening_num,
        sc.movie_num,

        i.movie_num,
        i.movie_title,
        i.running_time,
        i.audience_rating,

        th.screening_num AS th_screening_num,
        th.screening_number,
        th.branch_num,

        cf.branch_name,
        cf.address

        FROM T_ReservationInfo r
        JOIN T_Seat s ON r.seat_number = s.seat_code
        JOIN T_MemberInfo m ON r.phone_number = m.phone_number
        JOIN T_Schedule sc ON r.schedule_num = sc.schedule_num
        JOIN T_Info i ON sc.movie_num = i.movie_num
        JOIN T_Theater th ON sc.screening_num = th.screening_num
        JOIN T_CinemaFranchise cf ON th.branch_num = cf.branch_num

        WHERE r.reservation_num = #{reservationNum}
    </select>

    <!-- ðŸ” íŠ¸ëžœìž­ì…˜ ë²ˆí˜¸ë¡œ ì˜ˆë§¤ ì¡°íšŒ (â­ ì¶”ê°€) -->
    <select id="findByTransactionNum" parameterType="long" resultMap="reservationInfoDetailResultMap">
        SELECT
        r.reservation_num,
        r.seat_number,
        r.payment_time,
        r.state,
        r.phone_number,
        r.schedule_num,
        r.booking_group_id,
        r.transaction_num,

        s.seat_code,
        s.seat_type,
        s.price,
        s.screening_num,
        s.is_aisle,
        s.row_label,
        s.col_num,

        m.member_code,
        m.member_name,
        m.id,
        m.password,
        m.phone_number,

        sc.schedule_num,
        sc.screening_date,
        sc.screening_num,
        sc.movie_num,

        i.movie_num,
        i.movie_title,
        i.running_time,
        i.audience_rating,

        th.screening_num AS th_screening_num,
        th.screening_number,
        th.branch_num,

        cf.branch_name,
        cf.address

        FROM T_ReservationInfo r
        JOIN T_Seat s ON r.seat_number = s.seat_code
        JOIN T_MemberInfo m ON r.phone_number = m.phone_number
        JOIN T_Schedule sc ON r.schedule_num = sc.schedule_num
        JOIN T_Info i ON sc.movie_num = i.movie_num
        JOIN T_Theater th ON sc.screening_num = th.screening_num
        JOIN T_CinemaFranchise cf ON th.branch_num = cf.branch_num

        WHERE r.transaction_num = #{transactionNum}
        LIMIT 1
    </select>

    <!-- ðŸ”„ íŠ¸ëžœìž­ì…˜ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (â­ ì¶”ê°€) -->
    <update id="updateTransactionNum">
        UPDATE T_ReservationInfo
        SET transaction_num = #{transactionNum}
        WHERE booking_group_id = #{bookingGroupId}
    </update>

    <!-- ðŸ”„ íŠ¸ëžœìž­ì…˜ ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (PhoneNumber + ScheduleNum) (â­ ì¶”ê°€) -->
    <update id="updateTransactionNumByScheduleAndPhone">
        UPDATE T_ReservationInfo
        SET transaction_num = #{transactionNum}
        WHERE phone_number = #{phoneNumber}
          AND schedule_num = #{scheduleNum}
          AND state = 'ì˜ˆë§¤ì™„ë£Œ'
          AND transaction_num IS NULL
    </update>


</mapper>
