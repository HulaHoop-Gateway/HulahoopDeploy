<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.novacinema.schedule.model.dao.ScheduleMapper">

    <!-- ðŸŽ¬ ê¸°ë³¸ ìƒì˜ ì¼ì • ë§¤í•‘ -->
    <resultMap id="scheduleBasicResultMap" type="com.novacinema.schedule.model.dto.ScheduleDTO">
        <id property="scheduleNum" column="schedule_num"/>
        <result property="screeningDate" column="screening_date" javaType="java.time.LocalDateTime"/>
        <result property="screeningNum" column="screening_num"/>
        <result property="movieNum" column="movie_num"/>
    </resultMap>

    <!-- ðŸŽ¥ ìƒì„¸ ìƒì˜ ì¼ì • ë§¤í•‘ (ì˜í™” + ìƒì˜ê´€ + ì§€ì  ì •ë³´ í¬í•¨) -->
    <resultMap id="scheduleDetailResultMap" type="com.novacinema.schedule.model.dto.ScheduleDTO">
        <id property="scheduleNum" column="schedule_num"/>
        <result property="screeningDate" column="screening_date" javaType="java.time.LocalDateTime"/>
        <result property="screeningNum" column="screening_num"/>
        <result property="movieNum" column="movie_num"/>

        <association property="movieInfo" javaType="com.novacinema.info.model.dto.InfoDTO">
            <result property="movieNum" column="movie_num"/>
            <result property="movieTitle" column="movie_title"/>
            <result property="runningTime" column="running_time"/>
            <result property="audienceRating" column="audience_rating"/>
        </association>

        <association property="theaterInfo" javaType="com.novacinema.theater.model.dto.TheaterDTO">
            <result property="screeningNum" column="screening_num"/>
            <result property="screeningNumber" column="screening_number"/>
            <result property="branchNum" column="branch_num"/>

            <association property="cinemaFranchisedto" javaType="com.novacinema.cinemaFranchise.model.dto.CinemaFranchiseDTO">
                <result property="branchNum" column="branch_num"/>
                <result property="branchName" column="branch_name"/>
                <result property="address" column="address"/>
            </association>
        </association>
    </resultMap>

    <!-- ðŸ“… ê¸°ë³¸ ì „ì²´ ìŠ¤ì¼€ì¤„ ì¡°íšŒ -->
    <select id="selectAllSchedules" resultMap="scheduleDetailResultMap">
        SELECT
        s.schedule_num,
        s.screening_date,
        s.screening_num,
        s.movie_num,
        f.movie_title,
        f.running_time,
        f.audience_rating,
        t.screening_number,
        t.branch_num,
        c.branch_name,
        c.address
        FROM T_Schedule s
        JOIN T_Info f ON s.movie_num = f.movie_num
        JOIN T_Theater t ON s.screening_num = t.screening_num
        JOIN T_CinemaFranchise c ON t.branch_num = c.branch_num
    </select>

    <!-- ðŸ”¥ ë‚ ì§œ ê¸°ë°˜ ì¡°ê±´ ì¶”ê°€: ì˜¤ëŠ˜/ë‚´ì¼/íŠ¹ì • ë‚ ì§œ í•„í„°ë§ -->
    <select id="findSchedulesByBranchNumAndDate" resultMap="scheduleDetailResultMap">
        SELECT
        s.schedule_num,
        s.screening_date,
        s.screening_num,
        s.movie_num,
        f.movie_title,
        f.running_time,
        f.audience_rating,
        t.screening_number,
        t.branch_num,
        c.branch_name,
        c.address
        FROM T_Schedule s
        JOIN T_Info f ON s.movie_num = f.movie_num
        JOIN T_Theater t ON s.screening_num = t.screening_num
        JOIN T_CinemaFranchise c ON t.branch_num = c.branch_num
        WHERE t.branch_num = #{branchNum}

        <!-- â­ íŠ¹ì • ë‚ ì§œê°€ ì˜¤ë©´ í•´ë‹¹ ë‚ ì§œë§Œ ì¡°íšŒ -->
        <if test="screeningDate != null and screeningDate != '' and screeningDate != 'today' and screeningDate != 'tomorrow'">
            AND DATE(s.screening_date) = DATE(#{screeningDate})
        </if>

        <!-- â­ ë‚´ì¼: ë‚ ì§œë§Œ í•„í„°ë§í•˜ê³  ì‹œê°„ ì¡°ê±´ì€ ì ìš©í•˜ì§€ ì•ŠìŒ -->
        <if test="screeningDate == 'tomorrow'">
            AND DATE(s.screening_date) = DATE(DATE_ADD(CURDATE(), INTERVAL 1 DAY))
        </if>

        <!-- â­ ì˜¤ëŠ˜: ë‚ ì§œ + í˜„ìž¬ ì‹œê°„ ì´í›„ë§Œ -->
        <if test="screeningDate == 'today'">
            AND DATE(s.screening_date) = CURDATE()
            AND TIME(s.screening_date) >= CURTIME()
        </if>

        <!-- â­ ë‚ ì§œ ì§€ì •ì´ ì „í˜€ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ + í˜„ìž¬ ì‹œê°„ ì´í›„ë§Œ -->
        <if test="screeningDate == null or screeningDate == ''">
            AND DATE(s.screening_date) = CURDATE()
            AND TIME(s.screening_date) >= CURTIME()
        </if>

        ORDER BY s.screening_date ASC
    </select>

    <select id="findMerchantCodeByScheduleNum" resultType="string">
        SELECT c.branch_name
        FROM T_Schedule s
        JOIN T_Theater t ON s.screening_num = t.screening_num
        JOIN T_CinemaFranchise c ON t.branch_num = c.branch_num
        WHERE s.schedule_num = #{scheduleNum}
        LIMIT 1
    </select>

    <!-- â­ íŠ¹ì • ìŠ¤ì¼€ì¤„ ìƒì„¸ ì¡°íšŒ (ì˜í™” ì •ë³´ í¬í•¨) -->
    <select id="selectScheduleByNum" resultMap="scheduleDetailResultMap">
        SELECT
        s.schedule_num,
        s.screening_date,
        s.screening_num,
        s.movie_num,
        f.movie_title,
        f.running_time,
        f.audience_rating,
        t.screening_number,
        t.branch_num,
        c.branch_name,
        c.address
        FROM T_Schedule s
        JOIN T_Info f ON s.movie_num = f.movie_num
        JOIN T_Theater t ON s.screening_num = t.screening_num
        JOIN T_CinemaFranchise c ON t.branch_num = c.branch_num
        WHERE s.schedule_num = #{scheduleNum}
    </select>




</mapper>
