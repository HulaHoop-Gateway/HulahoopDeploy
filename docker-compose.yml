services:
  # ===========================
  # Gateway (API Entry)
  # ===========================
  gateway-back:
    build: ./Gateway
    container_name: gateway-back
    ports:
      - "8080:8080"
    env_file: .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xmx256m
    depends_on:
      - blue-back
      - red-back
      - cinema-back
      - bike-back
    networks:
      - app-net

  # ===========================
  # Blue (AI Chat) - DB: hulahoopdb
  # ===========================
  blue-front:
    build: ./Blue-front
    container_name: blue-front
    ports:
      - "5173:5173"
    networks:
      - app-net
    environment:
      - NODE_OPTIONS=--max-old-space-size=256

  blue-back:
    build: ./Blue-back
    container_name: blue-back
    ports:
      - "8090:8090"
    env_file: .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xmx256m
      # DB 설정 (기본값 사용)
      - DB_URL=${DB_URL}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      # 메일 및 API 키
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - KAKAO_API_KEY=${KAKAO_API_KEY}
      - TOSS_SECRET_KEY=${TOSS_SECRET_KEY}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - app-net

  # ===========================
  # Red (Admin Front/Back) - DB: hulahoopdb
  # ===========================
  red-front:
    build: ./Red-front
    container_name: red-front
    ports:
      - "3000:3000"
    networks:
      - app-net
    environment:
      - NODE_OPTIONS=--max-old-space-size=256

  red-back:
    build: ./Red-back
    container_name: red-back
    ports:
      - "8000:8000"
    env_file: .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xmx256m
      - DB_URL=${DB_URL}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
    networks:
      - app-net

  # ===========================
  # Cinema (Movie) - DB: cinemadb
  # ===========================
  cinema-front:
    build: ./NovaCinema-front
    container_name: cinema-front
    ports:
      - "5175:5175"
    networks:
      - app-net
    environment:
      - NODE_OPTIONS=--max-old-space-size=256

  cinema-back:
    build: ./NovaCinema-back
    container_name: cinema-back
    ports:
      - "8082:8082"
    env_file: .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xmx256m
      # URL에서 hulahoopdb를 cinemadb로 교체하여 주입 (중요!)
      - DB_URL=jdbc:mysql://hulahoopdb.c38um8oygmhz.ap-northeast-2.rds.amazonaws.com:3306/cinemadb?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Seoul
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
    networks:
      - app-net

  # ===========================
  # Bike (Bikeway) - DB: bikewaydb
  # ===========================
  bike-front:
    build: ./Bikeway-front
    container_name: bike-front
    ports:
      - "5174:5174"
    networks:
      - app-net
    environment:
      - NODE_OPTIONS=--max-old-space-size=256

  bike-back:
    build: ./Bikeway-back
    container_name: bike-back
    ports:
      - "8081:8081"
    env_file: .env
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_TOOL_OPTIONS=-Xmx256m
      # URL에서 hulahoopdb를 bikewaydb로 교체하여 주입 (중요!)
      - DB_URL=jdbc:mysql://hulahoopdb.c38um8oygmhz.ap-northeast-2.rds.amazonaws.com:3306/bikewaydb?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Seoul
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
    networks:
      - app-net

# ===========================
# Networks
# ===========================
networks:
  app-net: